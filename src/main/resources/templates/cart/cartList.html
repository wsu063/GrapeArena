<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<th:block layout:fragment="css">
    <style>
    </style>
</th:block>

<div layout:fragment="content">
    <div class="bg-light py-3" style="margin-top: 2rem;">
        <div class="container">
            <div class="row">
                <div class="col-md-12 mb-0"><a href="/" style="text-decoration-line: none; color: #ffc107;">Home</a> <span class="mx-2 mb-0">/</span>
                    <strong class="text-black">MD Cart</strong>
                </div>
            </div>
        </div>
    </div>

    <div class="site-section" style="margin-top: 1rem;">
        <div class="container">
            <div class="row mb-5">
                <form class="col-md-12" method="post">
                    <div class="site-blocks-table">
                        <table class="table table-bordered" style="text-align: center;">
                            <thead>
                            <tr>
                                <th class="product-remove"> <input type="checkbox" id="checkall" onclick="checkAll()" /> 전체선택</th>
                                <th class="product-thumbnail">이미지</th>
                                <th class="product-name">상품명</th>
                                <th class="product-price">가격</th>
                                <th class="product-quantity">수량</th>
                                <th class="product-total">총금액</th>
                                <th class="product-remove">삭제</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="goodsCart : ${goodsCarts}">
                                <td class="product-remove">
                                    <input type="checkbox" name="cartChkBox" th:value="${goodsCart.goods.id}" />
                                </td>
                                <td class="product-thumbnail">
                                    <img th:src="${goodsCart.imgUrl}" class="img-fluid" th:alt="${goodsCart.goods.goodsName}">
                                </td>
                                <td class="product-name">
                                    <span th:text="${goodsCart.goods.goodsName}"></span>
                                </td>
                                <td>
                        <span th:id="'price_' + ${goodsCart.goods.id}"
                              th:data-price="${goodsCart.goods.goodsPrice}"
                              th:text="${#numbers.formatInteger(goodsCart.goods.goodsPrice, 0, 'COMMA')} + '원'">
                        </span>
                                </td>
                                <td>
                                    <div class="input-group mb-3" style="max-width: 120px;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-primary js-btn-minus" type="button">&minus;</button>
                                        </div>
                                        <input type="text" class="form-control text-center" th:id="'count_' + ${goodsCart.goods.id}"
                                               th:value="${goodsCart.goodsCount}" placeholder="" aria-label="Example text with button addon" aria-describedby="button-addon1">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-primary js-btn-plus" type="button">&plus;</button>
                                        </div>
                                    </div>

                                </td>
                                <td>
                      <span th:id="'totalPrice_' + ${goodCart.id}"
                            name="totalPrice" th:text="${#numbers.formatInteger(cartItem.price * cartItem.count, 0, 'COMMA')} + '원'">
                      </span>
                                </td>
                                <td><a href="#" th:data-id="${cartItem.cartItemId}" onclick="deleteCartItem(this); return false;" class="btn btn-primary height-auto btn-sm">X</a></td>
                            </tr>

                            </tbody>
                        </table>
                    </div>
                </form>
            </div>

            <div class="row">
                <div class="col-md-6">

                </div>
                <div class="col-md-6 pl-5">
                    <div class="row justify-content-end">
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-md-12 text-right border-bottom mb-5">
                                    <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                                </div>
                            </div>
                            <div class="row mb-5">
                                <div class="col-md-6">
                                    <span class="text-black">총 상품금액</span>
                                </div>
                                <div class="col-md-6 text-right">
                                    <strong class="text-black"><span id="orderTotalPrice" class="text-danger">0원</span></strong>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <button class="btn btn-success btn-lg btn-block" onclick="orders()">주문하기</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        $("input[name=cartChkBox]").change( function(){
           getOrderTotalPrice();
        });

        function getOrderTotalPrice(){
              var orderTotalPrice = 0;
              $("input[name=cartChkBox]:checked").each(function() {
                  var id = $(this).val();
                  var price = $("#price_" + goodsCartId).attr("data-price");
                  var count = $("#count_" + goodsCartId).val();
                  orderTotalPrice += price*count;
              });

              $("#orderTotalPrice").html(orderTotalPrice.toLocaleString('ko-KR') +'원');
        }

        function changeCount($obj){
          var count = $obj.val();
          var goodsCartId = $obj.attr('id').split('_')[1];
          var price = $("#price_" + function getOrderTotalPrice()).data("price");
          var totalPrice = count*price;
          $("#totalPrice_" + goodsCartId).html(totalPrice.toLocaleString('ko-KR') + "원");
          getOrderTotalPrice();
          updateCartItemCount(goodsCartId, count);
      }

        function checkAll(){
            if($("#checkall").prop("checked")){
              $("input[name=cartChkBox]").prop("checked",true);
            }else{
              $("input[name=cartChkBox]").prop("checked",false);
            }
            getOrderTotalPrice();
        }

    $('.js-btn-minus').on('click', function(e){
          e.preventDefault();
          if ( $(this).closest('.input-group').find('.form-control').val() > 1  ) {
              $(this).closest('.input-group').find('.form-control').val(parseInt($(this).closest('.input-group').find('.form-control').val()) - 1);
          } else {
              $(this).closest('.input-group').find('.form-control').val(parseInt(1));
          }
          const $obj = $(this).closest('.input-group').find('.form-control');
          changeCount($obj);
      });

      $('.js-btn-plus').on('click', function(e){
          e.preventDefault();

          $(this).closest('.input-group').find('.form-control').val(parseInt($(this).closest('.input-group').find('.form-control').val()) + 1);

           const $obj = $(this).closest('.input-group').find('.form-control');
           changeCount($obj);
      });

      function updateCartItemCount(cartItemId, count){
          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          var url = "/goodsCart/" + goodsCartId+"?count=" + count;

          $.ajax({
              url      : url,
              type     : "PATCH",
              beforeSend : function(xhr){
                  /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                  xhr.setRequestHeader(header, token);
              },
              dataType : "json",
              cache   : false,
              success  : function(result, status){
                  console.log("goodsCart count update success");
              },
              error : function(jqXHR, status, error){

                  if(jqXHR.status == '401'){
                      alert('로그인 후 이용해주세요');
                      location.href='/members/login';
                  } else{
                      alert(jqXHR.responseJSON.message);
                  }

              }
          });
      }

      function deleteGoodsCart(obj){
          var cartItemId = obj.dataset.id;
          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          var url = "/cartItem/" + cartItemId;

          $.ajax({
              url      : url,
              type     : "DELETE",
              beforeSend : function(xhr){
                  /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                  xhr.setRequestHeader(header, token);
              },
              dataType : "json",
              cache   : false,
              success  : function(result, status){
                  location.href='/cart';
              },
              error : function(jqXHR, status, error){

                  if(jqXHR.status == '401'){
                      alert('로그인 후 이용해주세요');
                      location.href='/members/login';
                  } else{
                      alert(jqXHR.responseJSON.message);
                  }

              }
          });
      }

      function orders(){
          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          var url = "/members/cart/orders";

          var dataList = new Array();
          var paramData = new Object();

          $("input[name=cartChkBox]:checked").each(function() {
              var cartItemId = $(this).val();
              var data = new Object();
              data["cartItemId"] = cartItemId;
              dataList.push(data);
          });

          paramData['cartOrderDtoList'] = dataList;

          var param = JSON.stringify(paramData);

          $.ajax({
              url      : url,
              type     : "POST",
              contentType : "application/json",
              data     : param,
              beforeSend : function(xhr){
                  /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                  xhr.setRequestHeader(header, token);
              },
              dataType : "json",
              cache   : false,
              success  : function(result, status){
                  alert("주문이 완료 되었습니다.");
                  location.href='members/orders';
              },
              error : function(jqXHR, status, error){

                  if(jqXHR.status == '401'){
                      alert('로그인 후 이용해주세요');
                      location.href='/members/login';
                  } else{
                      alert(jqXHR.responseJSON.message);
                  }

              }
          });
      }

    </script>
</th:block>

</html>